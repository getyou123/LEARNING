### 资料参考
- 离线和实时大数据开发实战 pdf
- 公众号 数仓与大数据 相关的规范

### 无论是接手还是重构新建 都需要产出具体的文档，这有利于很快的理解业务
- 业务架构（回答为了哪些战略目的价值有啥 用户是谁 从战略上看）
- 应用架构（回答如何从战术上看如何满足战略：业务架构中的一个模块对应此中的一个模块是如何通过各种应用来实现的）
- 技术架构（回答这些应用用到了哪些数仓技术：技术选型 数仓的选型：大数据数仓 实时数仓 流批一体数仓 数据湖数仓，都用到了哪些技术 ）
- 数据架构（回答数据是如何分层，如何分域的：输出分层规划，输出数据域划分）
- ETL架构（回答分层数据和分域数据的ETL流程模块划分 依赖关系 调用关系 任务调度和管理）
- 部署架构（回答应用服务器梳理 配置 连通性情况）


下面对于各种架构做逐一说明，梳理这些架构需要产出对应的文档，这是你嵌入到业务深度的体现，可以从上层一直到最底层，然后一步一步的详细补充图
1. 业务架构：  
   ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404270945571.png)
2. 应用架构（哪些系统支持了哪些业务）  
   ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404271013677.png)
3. 技术架构（这些系统里有哪些技术选型）  
   ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404271015831.png) 这是大数据数仓 ，实时数仓，流批一体 数据湖
4. 数据架构：  
   数据仓库是如何分层的  
   ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404271406609.png) 常见的分层结构
5. ETL架构： 
   这个描述所有的任务依赖调度，数据结果产出，从上面的数据结构一点一点的细化出来,这是一张很大ETL图，可以通过一些工具获得完整的展示 比如 grpahviz画一个svg
6. 具体的应用需要有专门的建模文件产出



### 数仓的定义：
数仓的定义是面向一下的一些特征来说明的：
> 1. 面向主题。主要是给数据分类方便理解和管理。
> 2. 集成。汇总多个源端系统数据甚至是异构数据源，到一个统一的相互兼容的数据存储内，使后续的分析关联更加容易。
> 3. 相对稳定。对数据的操作大多是 Insert，很少有 Update、Delete。
> 4. 反应历史变化。存储大量的历史数据,保留历史所有数据的状态，进而找出企业经营管理中的规律。我觉得这里应该包含两个层面：>化规律、维度数据的历史变化。

用于支持管理决策。这是构建数仓的目的。但是发展到现在，数仓已经在别的很多地方开始发挥作用了。

### 数仓的设计理念
- 据模型的维度设计主要以维度建模理论为基础，基于维度数据模型总线架构，构建一致性的维度和事实。
- 采用宽表的设计方法， 所谓宽表：为了提升访问便利性和访问性能，在维度模型的事实表基础上，将部分常用维度退化（冗余）到事实表，或者将一些可枚举型的维度和度量，采用多指标、多字段方式实现在事实表中。
- 在指标定义中，采取组件化的形式，进行指标标准化定义，先规范定义，后生产，全生命周期控制，保障数据口径统一，减少重复建设，强调数据复用和共享

### 度量的概念？
- 就是事实表中的字段

### 事实表的粒度
在ER模型中抽象出了有实体、关系、属性三种类别，在现实世界中，每一个操作型事件，基本都是发生在实体之间的，伴随着这种操作事件的发生，会产生可度量的值，而这个过程就产生了一个事实表，存储了每一个可度量的事件。
![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260743021.png)
事实表中不仅包含了操作的事件的度量，也包含了外键，这些外键就是分析的角度。

- 事实表的粒度：超市购物的过程中，可以为小票建立事实表，也可以为小票子项建立事实表，维度建模一直认为应该是具有原子性的去存储事实，这样可以保留最底层、最原始的细节。

### 构建数仓的基本原则？数仓高内聚低耦合是怎么做的？核心模型与扩展模型分离是如何做的？
> 1、高内聚和低耦合：一个逻辑和物理模型由哪些记录和字段组成，
> 应该遵循最基本的软件设计方法论的高内聚和低耦合原则。主要从数据业务特性、访问特性、计算特性等方面来考虑：
> 将业务相近或者相关的数据、粒度相同数据设计为一个逻辑或者物理模型；将高概率同时访问的数据放一起，
> 将低概率同时访问的数据分开存储，针对计算依赖的数据产出时间是否相近，
> 计算是否能同时产出等原则确定组合在一起还是拆分。  
> 2、核心模型与扩展模型分离：
> 建立核心模型与扩展模型体系，核心模型包括的字段支持常用核心的业务，
> 扩展模型包括的字段支持个性化或是少量应用的需要，必要时让核心模型与扩展模型做关联，不能让扩展字段过度侵入核心模型，破坏了核心模型的架构简洁性与可维护性。  
> 3、公共处理逻辑下沉及单一：
> 越是底层公用的处理逻辑更应该在数据调度依赖的底层进行封装与实现，不要让公共的处理逻辑暴露给应用层实现，
> 不要让公共逻辑在多处同时存在。公共处理逻辑下沉及单一，既有利于数据复用，也有利于变更修改。  
> 4、成本与性能平衡：
> 适当的数据冗余换取查询和刷新性能，但是不宜过度冗余与数据复制。  
> 5、数据可回滚：
> 数据计算处理逻辑不变，在不同时间多次运行数据结果确定不变。  
> 6、数据一致性：
> 相同的字段在不同表字段命名和定义相同。  
> 7、命名清晰可理解：
> 表命名规范需清晰、一致，易于下游理解和使用  

核心在于公共逻辑处理下沉单一，核心模型不要被扩展模型侵入

### 三范式：经典的关系数据模型规范理论

1. 属性不可拆分。保证列的原子性。例如不能把学生的的学号、名称、班级号都塞在一个字段里面
2. 每个属性有且仅依赖于主键（主键的定义：能够唯一确定一条数据的列或列组合）。
3. 属性不能传递依赖于主键。如果有就分表。例如行政区划的省市县三层划分必须建三张表，省市的名称不能放到区县的那张表里（当然这种情况下，维度建模通常是反三范式的）

### 关于维度建模和范式建模？
1. 为啥要进行数据建模
> 提高性能
> 减少冗余
> 降低成本

2. 维度建模和范式建模的对比
- 维度建模：
> - 维度建模以分析决策的需求出发构建模型，构建的数据模型为分析需求服务，
> 因此它重点解决用户如何更快速完成分析需求，同时还有较好的大规模复杂查询的响应性能。
> 维度建模是面向分析的，为了提高查询性能可以增加数据冗余，反规范化的设计技术。  
> - 将表分为 维度表 和 事实表
> - 强调事实和维度的概念，维度建模的产出是`星型模型`或者是`雪花模型`，模型其实就是在论述表和表直接的关系，这种主要用在OLAP场景
- 范式建模：一种基于E-R图的，每个E存一个表，每个R存一个表，很少冗余信息的，需要大量的join的，减少存储消耗的；构建过程是从下到上的；这种的一般用在OLTP场景
- 两种建模方式的对比：
- ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202305041755024.png)
- ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202305041757979.png)
- ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202305041757946.png)

### 什么是事实表，什么是维度表，什么是维度，什么是指标？

- 事实表：就是要研究和分析对象之间发生的事件，常见的比如是订单这个业务过程中的用户 时间 平台 等各种对象之间的下单行为
- 维度表：就是研究事件时候研究的角度，从哪个角度去看研究事件，研究时间中的对象，比如研究订单的日期，那么时间就是一个维度表
- 维度：就是角度，比如 日期
- 指标：其实是如何去量化研究的结果，日期角度来看的下单量
- 维度+指标：从哪些角度去事实表+看出来哪些指标

### 雪花模型和星型模型的区别，如何转化呢？

- 星型模型   
  ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202305041807891.png)
- 雪花模型 
  ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202305041809686.png)

根据项目经验，一般建议使用星型模型。因为在实际项目中，往往最关注的是查询性能问题，至于磁盘空间一般都不是问题。当然，在维度表数据量极大，需要节省存储空间的情况下，或者是业务逻辑比较复杂、必须要体现清晰的层次概念情况下，可以使用雪花型模型。

### 维度建模理论？

关注事实，即关注指标的落点，允许大量的冗余，减少join等操作，按照星星模型去组织这些表，描述他们的关系

1. 维度表的分类：
   1. 维度退化： 直接把维度信息退化到事实表中，不用主键进行关联了
   2. 缓慢变化维：
      1. 行为维度 这是SCD的常见的一种类型，比如根据用户的历史下单情况对用户进行分层
   3. 快变超大维度：快变超大维度：数百万记录，数亿行记录且他们经常变化，那就把这些经常分析的或者变化频率比较高的单独提取出来，建立一个单独的维度表，这个单独的维度表就是微型维度，注意这里这个表有自己的关键字
   4. 多值维度： 一些字段本来应该是单值的，比如债权人，但是可能存在联合账户，那就通过加列的方式 债权人1 债权人2 通过这种扁平化的方式加进去
2. 事实表的分类：
   1. 事务性事实表
   2. 周期型事实表
   3. 累积性事实表
3. 总线结构和总线矩阵：![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202305041811540.png)
4. 管理产出指标的结果表：![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202305041813943.png)

### 多维分析的基本操作：
1. 钻取：上卷或下钻。通过调整维度的个数，来变换分析的粒度。
2. 切片与切块：选取整体的部分维度去看度量，选两个就是切片，三个或以上是切块
3. 旋转:例如行列转换

### 如何处理缓慢变化维（SCD）：
维度是出于变化中的，不是一成不变的，要根据维度变化内容和对于下游统计的影响来实际参考，下面是一些常见的处理方式：  

- 全部覆盖：如果维度值变化了但是对于后续指标没有影响的话，直接覆盖 ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260718776.png) 
- 新增一个维度行，即：保留旧的，也有保留了新的，都存在维度表中 ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260718574.png) 这种的需要在事实表中也进行新的新增
- 插入新的维度列，就是在维度表上新增pre列和after列 ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260719032.png) 这种变化次数较多的不是很合适
- 快照维度：就是每天存一份

所有的维度变化可以通过这三种方式来操作完成，覆盖 加行 加列 三者其一，多值维度也可以采用扁平化加列来完成

### 什么是维度层次？
维度数据存在一些层级从属关系，比如类目，品牌关系等，二级类目从属一级类目，一个商品一定是挂载对应的最低级的类目上的，那么和订单关联的类目维度表是扁平的存储，还是范式的那种维护关系表呢
- 第一种：冗余到一个表中，多个列，分别表示对应的一级 二级 三级
- 第二种方式：表A全是三级的，记录一个二级的id，然后表B记录二级的，记录一个一级id，然后表C存一级的
- 提倡使用 冗余的操作，把商品的一二三级类目都放在维度表中，这样订单关联算是一种星型模型，而非雪花模型  
  ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260755301.png)

### 一致性维度
背景：数据仓库是多个主题，多个业务过程，这是一个逐步构建的过程，
其实是物理上的数据集市组合成逻辑上的数据仓库，但是在多个数据集市中，
无论是在单个集市的建立过程，还是在多个数据集市之间，维度的口径必须是一致的，否则就会出现数据孤岛，
不能组成逻辑上一个数据仓库。

一致性维度是指：  
维度一致性的意思是指，两个维度如果有关系，要么就是完全一样的，要么就是一个维度在数学意义上是另一个维度的子集。

如果一致性维度不满足会咋样？
> 比如有些订单的维度数据是在本公司加工的大，是导流到其他的平台成单，公司平台和其他的平台的类目维度表不一致，
> 那么在跨浏览域和交易域对类目进行分析的时候就无法完成，我们计算不了某个类目的CTR，因为划分类目不一致
> 因为维度不同，就不能按照维度聚合分析，分析出来的结果也不能正确关联，
> 那么就无法进一步加工(流量group by 类目 之后 无法和 订单 group by 类目后 再join上)

如何保证数据维度的一致性呢？  
要么各个集市使用的是都一张表，要么各个维度使用都是来自同一个表的视图。

### 维度整合和拆分
就是前台的业务系统中对于同一个维度的描述存在差异，比如命名规范，字段类型，字段的编码和含义不一致等  
这个时候就需要把所有的相关业方找到，共同的讨论和确定整合的逻辑，敲定为统一的

表的一些字段是基本信息字段，另外一部分是扩展信息： （商家的名称 注册地址  + 商家的30天订单量 30天的DAU等）
这部分信息原本存在一起，拆分开就是所谓的垂直拆分，组合在一起就是垂直组合

表的一些字段是多个可以存为多个枚举值的，比如 商品的销售渠道的信息 (商品ID + 拼多多；淘宝；京东)
如果炸开存储为多行就是水平拆分，如果组合在一起就是水平组合

一般来说维度的拆分是为了更好的满足使用基本信息维度的下游的时效性。


### 数仓的基本分层理论：
OneData体系中，数据划分为三层：  
• ODS（Operational Data Store）：
  原始操作层，主要完成业务系统、日志等结构化和半结构化数据引入到数据中台，保留业务系统原始数据，包括增量明细和全量明细。  
• CDM（Common Data Model）：
  通用数据模型，主要完成公共数据加工与整合，建立一致性的维度，构建可复用面向分析和统计的明细事实表以及汇总公共粒度的指标。  
• ADS（Application Data Service）：
  应用层数据，提供直接面向业务应用的数据。为方便实现数据应用、数据消费的诉求，进行数据形式的组装，进行面向应用逻辑的数据加工处理。

其中在CDM层，由以下几部分组成：  
• DIM（Dimension），公共维度层，基于维度建模理念思想，建立企业的一致性维度。  
• DWD（Data Warehouse Detail），明细粒度事实层，以业务过程作为建模驱动，基于每个具体的业务过程特点，构建最细粒度的明细层事实表，结合企业的数据使用特点，
  将明细事实表的某些重要维度属性字段做适当冗余，也就是宽表化处理。  
• DWS（Data Warehouse Summary），公共汇总粒度事实层：
  以分析的主题对象作为建模驱动，基于上层的应用和产品的指标需求，构建公共粒度的汇总指标事实表，以宽表化手段物理化模型。


CDM层任务的深度不宜过大（建议不超过10层）。
原则上一个计算刷新任务只允许一个输出表。如果多个任务刷新输出一个表（不同任务插入不同的分区），需要建立一个虚拟任务，依赖多个刷新任务，通常情况下游应该依赖此虚拟任务。
CDM汇总层优先调用CDM明细层。可累加类指标计算，CDM汇总层尽量优先调用已经产出的粗粒度汇总层，避免大量汇总都直接从海量的明细数据层计算。
CDM明细层累计快照事实表优先调用CDM事务型事实表，保持数据一致性产出。
避免应用层过度引用和依赖CDM层明细数据，有针对性建设好CDM公共汇总

> 1. ods层，这是基础的来拉取和接入数据的层
> 2. dwd层，对一个数据明细层，主要从ods加工来的，用来描述具体的业务过程的表，比如 描述 搜索->展示->点击->下单全链路的dwd层表，或者只描述展示->点击->下单这部分的dwd，总之dwd是用来描述业务过程的，粒度的话这里保持最细粒度
> 3. dws层，在dwd的基础上做一些轻度的聚合操作，其实需要关注下游的使用情况，来决定这层的聚合粒度，比如 如果只关注 pv ，那可以在省份上聚合pv，但是如何关注uv的话，就不能在省份上聚合为uv值，因为下层使用的时候现在不可加和
> 4. ads层，这次就是面向应用了，具体的指标具体的分析
> 5. dim层，维度层

![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260750700.png)

### 数据集市和数据仓库的区别？
- 一般来说数据集市是部门性质的，topic较少的
- 数据仓库是全公司的，面向企业的，topic比较多

### 命名规范？

#### 表名

#### 任务名称

#### 加工脚本名

#### 代码类名

### 维度建模的过程？
过程理论如下：
> 1. 选择业务过程：业务线选择出来
> 2. 声明粒度： 一行表示的业务过程是如何的，这个决定了表的量级，在业务过程中如何产生这样一条数据
> 3. 确认维度：观察事实的角度
> 4. 确认事实：定义描述业务过程中的每个度量

总的过程如下：
![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260736409.png)

过程实践如下：
1. 超市零售业务过程来建模  
   ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260737817.png)
2. 超市库存业务过程来建模  
   ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260739708.png)
3. 车险理赔业务过程来建模  
   ![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260740692.png)

- 维度建模的产出是啥？
是符合星型模型的一个建模的图，里面包含所有的相关表和字段，用来指导我们构建宽表

### 一份数据报告的内容应该如何去做呢？
![](https://raw.githubusercontent.com/getyou123/git_pic_use/master/zz202404260745658.png)

### 关于数仓的规范
为啥需要规范？  
俗话说的好，无规矩不成方圆，没有规范岂不乱套了? 个人觉得，规范是为了解决团体作战中的效率和协同问题，是对最终交付质量的有力保证。 大家工作中有没有遇到类似的问题？    
• 接到了一个需求，不知道该从那张表出数，表A貌似可以，表B好像也行。问了同事甲，他说他每次都是从C表出的。对着三张表探索了好久，发现谁跟谁都对不上，算了吧，我从源头再算一次吧，结果又变出来一张表D。    
• 数据库里几千张表，好像我用到的也就那么十几张，其它的都是干啥用的呢，问了一圈没有人知道，删掉吧？更没有人敢动。  
• 有个流程报错了，领导让我去看一下，点进去后，屎一样的代码完全看不懂，另外，找了好久死活找不到上游依赖。  
• 有位同事要离职，他负责的那部分内容，换了一个人接手，累死累活好多天依然捋不出个所以然，一气之下又走了一个人。  
由于以上种种问题，造成数仓团队的整体开发效率、产出质量、工作幸福感、数仓维护成本等等越来越差。
随着人员流动，通常受累的往往是那些任劳任怨、对公司忠诚的员工。相信做过数据开发的人，
多多少少都会有过上边提到的部分苦恼。我觉得问题的根源通常在于没有规范或者规范没有得到贯彻。
大家有时候为了按时完成业务侧的需求，走些捷径也是可以理解的，但是欠下的技术债应该尽早还上，并且组织不应该苛责员工，这个锅应该领导来背。
领导重视大家就都重视，领导不重视，岂不各个放飞自我了？

数据仓库，是我们数据工程师的无形产品。数据规范是数仓体系建设的"语言"，
是数据使用的说明书和翻译官，同时也是数据质量的保驾护航者。为了数据体系能够长久健康的发展，
数仓管理，应该从人治逐步转变到制度化、规范化、工具化的道路上了来。

### 数据仓库指标体系建设：


### 常见的维度


### 常见的指标


